generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  COMMISSIONER
  DEPARTMENT_HEAD
  ZONAL_OFFICER
  WARD_OFFICER
  WARD_COUNCILLOR
  CITIZEN
}

enum TicketStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  VERIFIED
  CLOSED
}

enum EvidenceType {
  BEFORE
  AFTER
}

model User {
  id             String    @id @default(uuid())
  name           String
  phone          String?   @unique
  email          String?   @unique
  passwordHash   String?
  role           Role      @default(CITIZEN)
  
  // Relationships for hierarchy
  wardId         String?
  zoneId         String?
  departmentId   String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  createdTickets Ticket[]  @relation("TicketCreator")
  assignedJobs   Ticket[]  @relation("TicketAssignee")
  audits         AuditLog[]
  evidences      Evidence[]
}

model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  tickets   Ticket[]
}

model Zone {
  id        String   @id @default(uuid())
  name      String   @unique
  wards     Ward[]
}

model Ward {
  id        String   @id @default(uuid())
  name      String
  zoneId    String
  zone      Zone     @relation(fields: [zoneId], references: [id])
  tickets   Ticket[]
}

model Ticket {
  id                String       @id @default(uuid())
  ticketNumber      String       @unique // e.g., CIV-2025-04901
  title             String
  description       String
  category          String
  status            TicketStatus @default(OPEN)
  
  // AI fields
  priorityScore     Int          @default(0)
  reportCount       Int          @default(1)
  sentimentBoost    Int          @default(0)
  
  // Location
  latitude          Float?
  longitude         Float?
  
  // Timeline
  slaDeadline       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  resolvedAt        DateTime?
  closedAt          DateTime?
  
  // Relationships
  wardId            String
  ward              Ward         @relation(fields: [wardId], references: [id])
  departmentId      String
  department        Department   @relation(fields: [departmentId], references: [id])
  
  createdById       String
  createdBy         User         @relation("TicketCreator", fields: [createdById], references: [id])
  assignedOfficerId String?
  assignedOfficer   User?        @relation("TicketAssignee", fields: [assignedOfficerId], references: [id])
  
  evidences         Evidence[]
  auditLogs         AuditLog[]
}

model Evidence {
  id           String       @id @default(uuid())
  type         EvidenceType
  photoUrl     String
  gpsLat       Float?
  gpsLng       Float?
  aiConfidence Float?
  
  ticketId     String
  ticket       Ticket       @relation(fields: [ticketId], references: [id])
  
  uploadedById String
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])
  
  uploadedAt   DateTime     @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  details   String?
  
  ticketId  String?
  ticket    Ticket?  @relation(fields: [ticketId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  timestamp DateTime @default(now())
}
